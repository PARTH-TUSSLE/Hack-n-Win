<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <!-- <link rel="stylesheet" href="style.css" /> -->
    <link rel="icon" href="data:,">
  </head>
  <body>
    <h1>Welcome to Your Dream Dashboard</h1>
    <p id="user-info">Loading user info...</p>

    <h2>Log Your Dream</h2>
    <textarea id="dream-text" placeholder="Describe your dream..."></textarea>
    <button id="submit-dream">Submit Dream</button>

    <h2>Your Saved Dreams</h2>
    <ul id="dream-list"></ul>

    <button id="logout-btn">Log Out</button>

    <script type="module">
      import { logOutUser } from "./auth.js";
      import { db, collection, addDoc, getDocs } from "./firebase.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const auth = getAuth(); //  Fix: Only calling getAuth() here, no re-declaration
      const userInfo = document.getElementById("user-info");
      const dreamInput = document.getElementById("dream-text");
      const submitDreamBtn = document.getElementById("submit-dream");
      const dreamList = document.getElementById("dream-list");

      //  Check if user is logged in
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userInfo.innerText = `Logged in as: ${user.email}`;
          loadDreams(user.uid);
        } else {
          alert("You are not logged in!");
          window.location.href = "login.html"; // Redirect to login page
        }
      });

      //  Save Dream to Firestore
     async function saveDream(userId, dreamText) {
    try {
        const docRef = await addDoc(collection(db, "Dreams"), {
            userId: userId,
            text: dreamText,
            timestamp: new Date(),  //  Store timestamp for sorting
        });

        alert("Dream saved!");
        loadDreams(userId); // Reload dreams after saving
    } catch (error) {
        console.error(" Error saving dream:", error);
    }
}


//  Make editDream() accessible globally
window.editDream = async function (dreamId, oldText) {
    const newText = prompt("Edit your dream:", oldText);
    if (!newText) return; // User canceled edit

    try {
        await updateDoc(doc(db, "Dreams", dreamId), { text: newText });
        alert("Dream updated!");
        loadDreams(auth.currentUser.uid); // Reload dreams after editing
    } catch (error) {
        console.error(" Error updating dream:", error);
    }
};

//  Make deleteDream() accessible globally
window.deleteDream = async function (dreamId) {
    if (!confirm("Are you sure you want to delete this dream?")) return;

    try {
        await deleteDoc(doc(db, "Dreams", dreamId));
        alert("Dream deleted!");
        loadDreams(auth.currentUser.uid); // Reload dreams after deletion
    } catch (error) {
        console.error(" Error deleting dream:", error);
    }
};




      //  Load User's Dreams from Firestore
import { query, where, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"; //  Import Firestore functions

async function loadDreams(userId) {
    dreamList.innerHTML = "";

    const q = query(collection(db, "Dreams"), where("userId", "==", userId), orderBy("timestamp", "desc"));
    const querySnapshot = await getDocs(q);

    querySnapshot.forEach((docSnap) => {
        const dream = docSnap.data();
        const dreamId = docSnap.id;

        const li = document.createElement("li");
        li.innerHTML = `
            <span>${dream.text}</span>
            <button onclick="editDream('${dreamId}', '${dream.text}')">‚úèÔ∏è Edit</button>
            <button onclick="deleteDream('${dreamId}')">üóëÔ∏è Delete</button>
        `;
        dreamList.appendChild(li);
    });
}



      //  Handle Dream Submission
      submitDreamBtn.addEventListener("click", () => {
        const dreamText = dreamInput.value.trim();

        if (!dreamText) {
          alert("Please enter a dream before submitting.");
          return;
        }

        const user = auth.currentUser;
        if (!user) {
          alert("No user is logged in! Please log in again.");
          window.location.href = "login.html";
          return;
        }

        saveDream(user.uid, dreamText);
        dreamInput.value = "";
      });

      //  Logout Button
      document
        .getElementById("logout-btn")
        .addEventListener("click", logOutUser);
    </script>
  </body>
</html>
